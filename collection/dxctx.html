<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Linux多线程 | suting-Blogs</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="分布式博客云笔记">
    
    <link rel="preload" href="/assets/css/0.styles.386f4818.css" as="style"><link rel="preload" href="/assets/js/app.e2ddde8e.js" as="script"><link rel="preload" href="/assets/js/2.e74445cb.js" as="script"><link rel="preload" href="/assets/js/18.c5024350.js" as="script"><link rel="prefetch" href="/assets/js/10.383382f2.js"><link rel="prefetch" href="/assets/js/11.79913c72.js"><link rel="prefetch" href="/assets/js/12.18e85316.js"><link rel="prefetch" href="/assets/js/13.78e33ed3.js"><link rel="prefetch" href="/assets/js/14.92269bd7.js"><link rel="prefetch" href="/assets/js/15.acc92b96.js"><link rel="prefetch" href="/assets/js/16.d8716382.js"><link rel="prefetch" href="/assets/js/17.fa6a1da4.js"><link rel="prefetch" href="/assets/js/19.c3e206a7.js"><link rel="prefetch" href="/assets/js/20.6a00e35f.js"><link rel="prefetch" href="/assets/js/21.37c42ff6.js"><link rel="prefetch" href="/assets/js/22.abd1537f.js"><link rel="prefetch" href="/assets/js/23.6a041ee1.js"><link rel="prefetch" href="/assets/js/24.ab067683.js"><link rel="prefetch" href="/assets/js/25.a2de42cd.js"><link rel="prefetch" href="/assets/js/26.efa7caf3.js"><link rel="prefetch" href="/assets/js/27.1520ec85.js"><link rel="prefetch" href="/assets/js/28.be40ede1.js"><link rel="prefetch" href="/assets/js/29.5e42d4f2.js"><link rel="prefetch" href="/assets/js/3.fbcd2674.js"><link rel="prefetch" href="/assets/js/30.eae39a3c.js"><link rel="prefetch" href="/assets/js/31.63618f89.js"><link rel="prefetch" href="/assets/js/32.43b53339.js"><link rel="prefetch" href="/assets/js/33.931d2183.js"><link rel="prefetch" href="/assets/js/34.e7f37503.js"><link rel="prefetch" href="/assets/js/35.6302af3d.js"><link rel="prefetch" href="/assets/js/36.7aec4478.js"><link rel="prefetch" href="/assets/js/37.58461b9d.js"><link rel="prefetch" href="/assets/js/38.811a26e0.js"><link rel="prefetch" href="/assets/js/39.c3d07ac9.js"><link rel="prefetch" href="/assets/js/4.23df146b.js"><link rel="prefetch" href="/assets/js/40.b2c32317.js"><link rel="prefetch" href="/assets/js/41.368ac455.js"><link rel="prefetch" href="/assets/js/42.d68c9491.js"><link rel="prefetch" href="/assets/js/43.74a44b32.js"><link rel="prefetch" href="/assets/js/44.633f2e2b.js"><link rel="prefetch" href="/assets/js/45.eab6bf9b.js"><link rel="prefetch" href="/assets/js/46.3ddc24a7.js"><link rel="prefetch" href="/assets/js/5.4c581b45.js"><link rel="prefetch" href="/assets/js/6.27888615.js"><link rel="prefetch" href="/assets/js/7.e23a1d77.js"><link rel="prefetch" href="/assets/js/8.928501ca.js"><link rel="prefetch" href="/assets/js/9.0b4be001.js">
    <link rel="stylesheet" href="/assets/css/0.styles.386f4818.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">suting-Blogs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  home
</a></div><div class="nav-item"><a href="https://javaguide.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JavaGuide
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://home.code-nav.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  code-nav
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/sutinghu153" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://mp.weixin.qq.com/mp/profile_ext?action=home&amp;__biz=MzA5ODI3NTI1OA==&amp;scene=124#wechat_redirect" target="_blank" rel="noopener noreferrer" class="nav-link external">
  WK听潮
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/itdevbooks/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  book
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://beian.miit.gov.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  湘ICP备2021013988号-1
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  home
</a></div><div class="nav-item"><a href="https://javaguide.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JavaGuide
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://home.code-nav.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  code-nav
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/sutinghu153" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://mp.weixin.qq.com/mp/profile_ext?action=home&amp;__biz=MzA5ODI3NTI1OA==&amp;scene=124#wechat_redirect" target="_blank" rel="noopener noreferrer" class="nav-link external">
  WK听潮
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/itdevbooks/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  book
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://beian.miit.gov.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  湘ICP备2021013988号-1
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>个人项目</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>C/C++/Java/Golang</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux内核</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Linux系统开发</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/collection/xtkf.html" class="sidebar-link">IO-系统开发</a></li><li><a href="/collection/jcjtx.html" class="sidebar-link">进程间通信</a></li><li><a href="/collection/dxctx.html" aria-current="page" class="active sidebar-link">Linux多线程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/collection/dxctx.html#什么是线程" class="sidebar-link">什么是线程？</a></li><li class="sidebar-sub-header"><a href="/collection/dxctx.html#线程的周期" class="sidebar-link">线程的周期</a></li><li class="sidebar-sub-header"><a href="/collection/dxctx.html#线程的控制" class="sidebar-link">线程的控制</a></li><li class="sidebar-sub-header"><a href="/collection/dxctx.html#线程的同步" class="sidebar-link">线程的同步</a></li></ul></li><li><a href="/collection/netcode.html" class="sidebar-link">网络编程</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux/Makefile/Shell</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>区块链</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据结构</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>设计模式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机视觉</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>中间件</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>常用命令</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据库</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>系统部署</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="linux多线程"><a href="#linux多线程" class="header-anchor">#</a> Linux多线程</h1> <p>使用多线程的目的，是合理的利用资源，提高CPU的效率。</p> <blockquote><p><a href="https://zhuanlan.zhihu.com/p/158965214" target="_blank" rel="noopener noreferrer">进程、线程基础知识<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h2 id="什么是线程"><a href="#什么是线程" class="header-anchor">#</a> 什么是线程？</h2> <h3 id="关于进程"><a href="#关于进程" class="header-anchor">#</a> 关于进程</h3> <p>一个正在执行的程序，它是<strong>资源分配</strong>的<strong>最小单位</strong>，进程中的事情都需要按一定的时间顺序进行执行。</p> <h3 id="关于线程"><a href="#关于线程" class="header-anchor">#</a> 关于线程</h3> <p>进程只能按顺序执行，有很多问题</p> <ol><li>进程是资源拥有者，创建、销毁与切换存在较大的时空开销</li> <li>由于对称处理机（SMP）出现，可以满足多个运行单位，而多个进程并行开销过大</li></ol> <p>因此引入线程进行资源管理。</p> <p>线程有时被<strong>称为轻量级进程</strong>，<strong>程序执行的最小单位</strong>，<strong>系统独立调度和分配CPU的基本单位</strong>，它是<strong>进程中的一个实体</strong>，<strong>一个进程中可以有多个线程</strong>，这些<strong>线程共享进程的所有资源</strong>，线程本身只包含一点必备的资源。</p> <h3 id="线程和进程的关系"><a href="#线程和进程的关系" class="header-anchor">#</a> 线程和进程的关系</h3> <ol><li>以进程为主的编码方式被称为单线程的编码方式</li> <li>进程是线程的映射，线程是资源的消耗者，线程和进程是多对一的关系</li> <li>线程是进程的基本单位</li> <li>进程可以有多个线程，这些线程共享进程的所有资源</li> <li>子进程创建时会拷贝父进程所有的资源</li></ol> <h3 id="线程基本场景"><a href="#线程基本场景" class="header-anchor">#</a> 线程基本场景</h3> <h4 id="并发"><a href="#并发" class="header-anchor">#</a> 并发</h4> <p>在同一个时刻，只能有一条指令执行，但多进程模式下，指令能够快速轮换执行，使得在宏观上具有多个进程同时执行的效果。</p> <ul><li>看起来是同时发生</li> <li>单核处理</li></ul> <h4 id="并行"><a href="#并行" class="header-anchor">#</a> 并行</h4> <p>在同一时刻，有多条指令在多个处理器上同时执行。</p> <ul><li>真正的同时发生</li> <li>多核处理</li></ul> <h4 id="同步"><a href="#同步" class="header-anchor">#</a> 同步</h4> <p>彼此有依赖的调用不应该同时发生，而同步就是阻止那些”同时发生“的事。因此同步需要确定一些机制，来实现这个目的。</p> <h4 id="异步"><a href="#异步" class="header-anchor">#</a> 异步</h4> <p>异步和同步是相对的，表示任何两个彼此独立的操作是独立的，表明事情的发生独立性。</p> <h3 id="多线程的优势"><a href="#多线程的优势" class="header-anchor">#</a> 多线程的优势</h3> <ol><li>在多处理器中开发程序的并行性</li> <li>在等待慢速IO操作时，程序可以执行其它操作，提高并发性</li> <li>模块化的编程，能更清楚的表单程序独立事件的关系，结构清晰</li> <li>占用较少的系统资源（相对于多进程而言）</li> <li>多线程不一定需要多处理器</li></ol> <h2 id="线程的周期"><a href="#线程的周期" class="header-anchor">#</a> 线程的周期</h2> <h3 id="查看线程id"><a href="#查看线程id" class="header-anchor">#</a> 查看线程ID</h3> <blockquote><p>多线程头文件存在于以下目录</p> <p>/usr/include/bits/pthreadtypes.h</p></blockquote> <ul><li><p>线程ID : 无符号整数</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">int</span> <span class="token class-name">pthread_t</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>获取线程ID和进程ID的区别</p></li></ul> <table><thead><tr><th style="text-align:center;"></th> <th style="text-align:center;">线程</th> <th style="text-align:center;">进程</th></tr></thead> <tbody><tr><td style="text-align:center;">标识符类型</td> <td style="text-align:center;">pthread_t    无符号长整型</td> <td style="text-align:center;"><strong>pid_t</strong></td></tr> <tr><td style="text-align:center;">获取ID</td> <td style="text-align:center;">pthread_self();</td> <td style="text-align:center;">getpid();</td></tr> <tr><td style="text-align:center;">创建</td> <td style="text-align:center;">pthread_create();</td> <td style="text-align:center;">fork( void);</td></tr></tbody></table> <p><strong>查看进程、线程ID实例</strong></p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stdio.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;pthread.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;string.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stdlib.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;unistd.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;sys/types.h&quot;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token class-name">pthread_t</span> self<span class="token punctuation">;</span>
        <span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>
        pid <span class="token operator">=</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        self <span class="token operator">=</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;pid is %u,self is %u&quot;</span><span class="token punctuation">,</span>pid<span class="token punctuation">,</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="创建一个线程"><a href="#创建一个线程" class="header-anchor">#</a> 创建一个线程</h3> <ul><li><p>创建线程的方法</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;phread.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token class-name">pthread_t</span> <span class="token operator">*</span>id <span class="token punctuation">,</span> <span class="token class-name">pthread_attr_t</span> <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">*</span>fun<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li><p>id ：传递一个pthread_t类型的变量的地址，创建成功后，用来获取新创建的线程的TID</p></li> <li><p>attr：指定线程的属性 默认使用NULL 表示线程的调度策略、继承性、分离性</p></li> <li><p>fun：线程函数的地址，回调函数（新线程要执行的函数）</p></li> <li><p>arg：传递给线程函数的参数（回调函数的参数，多参数使用结构体传递）</p></li> <li><p>返回值，成功返回0，失败返回错误码</p> <ul><li><p>usr/include/asm-generic/errno.h 包含了所有的错误码</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EDEADLK</span>		<span class="token expression"><span class="token number">35</span>	</span><span class="token comment">/* Resource deadlock would occur */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ENAMETOOLONG</span>	<span class="token expression"><span class="token number">36</span>	</span><span class="token comment">/* File name too long */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ENOLCK</span>		<span class="token expression"><span class="token number">37</span>	</span><span class="token comment">/* No record locks available */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ENOSYS</span>		<span class="token expression"><span class="token number">38</span>	</span><span class="token comment">/* Function not implemented */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ENOTEMPTY</span>	<span class="token expression"><span class="token number">39</span>	</span><span class="token comment">/* Directory not empty */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ELOOP</span>		<span class="token expression"><span class="token number">40</span>	</span><span class="token comment">/* Too many symbolic links encountered */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EWOULDBLOCK</span>	<span class="token expression">EAGAIN	</span><span class="token comment">/* Operation would block */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ENOMSG</span>		<span class="token expression"><span class="token number">42</span>	</span><span class="token comment">/* No message of desired type */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EIDRM</span>		<span class="token expression"><span class="token number">43</span>	</span><span class="token comment">/* Identifier removed */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ECHRNG</span>		<span class="token expression"><span class="token number">44</span>	</span><span class="token comment">/* Channel number out of range */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EL2NSYNC</span>	<span class="token expression"><span class="token number">45</span>	</span><span class="token comment">/* Level 2 not synchronized */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EL3HLT</span>		<span class="token expression"><span class="token number">46</span>	</span><span class="token comment">/* Level 3 halted */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EL3RST</span>		<span class="token expression"><span class="token number">47</span>	</span><span class="token comment">/* Level 3 reset */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ELNRNG</span>		<span class="token expression"><span class="token number">48</span>	</span><span class="token comment">/* Link number out of range */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EUNATCH</span>		<span class="token expression"><span class="token number">49</span>	</span><span class="token comment">/* Protocol driver not attached */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ENOCSI</span>		<span class="token expression"><span class="token number">50</span>	</span><span class="token comment">/* No CSI structure available */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EL2HLT</span>		<span class="token expression"><span class="token number">51</span>	</span><span class="token comment">/* Level 2 halted */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EBADE</span>		<span class="token expression"><span class="token number">52</span>	</span><span class="token comment">/* Invalid exchange */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EBADR</span>		<span class="token expression"><span class="token number">53</span>	</span><span class="token comment">/* Invalid request descriptor */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EXFULL</span>		<span class="token expression"><span class="token number">54</span>	</span><span class="token comment">/* Exchange full */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ENOANO</span>		<span class="token expression"><span class="token number">55</span>	</span><span class="token comment">/* No anode */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EBADRQC</span>		<span class="token expression"><span class="token number">56</span>	</span><span class="token comment">/* Invalid request code */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EBADSLT</span>		<span class="token expression"><span class="token number">57</span>	</span><span class="token comment">/* Invalid slot */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EDEADLOCK</span>	<span class="token expression">EDEADLK</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EBFONT</span>		<span class="token expression"><span class="token number">59</span>	</span><span class="token comment">/* Bad font file format */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ENOSTR</span>		<span class="token expression"><span class="token number">60</span>	</span><span class="token comment">/* Device not a stream */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ENODATA</span>		<span class="token expression"><span class="token number">61</span>	</span><span class="token comment">/* No data available */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ETIME</span>		<span class="token expression"><span class="token number">62</span>	</span><span class="token comment">/* Timer expired */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ENOSR</span>		<span class="token expression"><span class="token number">63</span>	</span><span class="token comment">/* Out of streams resources */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ENONET</span>		<span class="token expression"><span class="token number">64</span>	</span><span class="token comment">/* Machine is not on the network */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ENOPKG</span>		<span class="token expression"><span class="token number">65</span>	</span><span class="token comment">/* Package not installed */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EREMOTE</span>		<span class="token expression"><span class="token number">66</span>	</span><span class="token comment">/* Object is remote */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ENOLINK</span>		<span class="token expression"><span class="token number">67</span>	</span><span class="token comment">/* Link has been severed */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EADV</span>		<span class="token expression"><span class="token number">68</span>	</span><span class="token comment">/* Advertise error */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ESRMNT</span>		<span class="token expression"><span class="token number">69</span>	</span><span class="token comment">/* Srmount error */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ECOMM</span>		<span class="token expression"><span class="token number">70</span>	</span><span class="token comment">/* Communication error on send */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EPROTO</span>		<span class="token expression"><span class="token number">71</span>	</span><span class="token comment">/* Protocol error */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EMULTIHOP</span>	<span class="token expression"><span class="token number">72</span>	</span><span class="token comment">/* Multihop attempted */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EDOTDOT</span>		<span class="token expression"><span class="token number">73</span>	</span><span class="token comment">/* RFS specific error */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EBADMSG</span>		<span class="token expression"><span class="token number">74</span>	</span><span class="token comment">/* Not a data message */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EOVERFLOW</span>	<span class="token expression"><span class="token number">75</span>	</span><span class="token comment">/* Value too large for defined data type */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ENOTUNIQ</span>	<span class="token expression"><span class="token number">76</span>	</span><span class="token comment">/* Name not unique on network */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EBADFD</span>		<span class="token expression"><span class="token number">77</span>	</span><span class="token comment">/* File descriptor in bad state */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EREMCHG</span>		<span class="token expression"><span class="token number">78</span>	</span><span class="token comment">/* Remote address changed */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ELIBACC</span>		<span class="token expression"><span class="token number">79</span>	</span><span class="token comment">/* Can not access a needed shared library */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ELIBBAD</span>		<span class="token expression"><span class="token number">80</span>	</span><span class="token comment">/* Accessing a corrupted shared library */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ELIBSCN</span>		<span class="token expression"><span class="token number">81</span>	</span><span class="token comment">/* .lib section in a.out corrupted */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ELIBMAX</span>		<span class="token expression"><span class="token number">82</span>	</span><span class="token comment">/* Attempting to link in too many shared libraries */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ELIBEXEC</span>	<span class="token expression"><span class="token number">83</span>	</span><span class="token comment">/* Cannot exec a shared library directly */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EILSEQ</span>		<span class="token expression"><span class="token number">84</span>	</span><span class="token comment">/* Illegal byte sequence */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ERESTART</span>	<span class="token expression"><span class="token number">85</span>	</span><span class="token comment">/* Interrupted system call should be restarted */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ESTRPIPE</span>	<span class="token expression"><span class="token number">86</span>	</span><span class="token comment">/* Streams pipe error */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EUSERS</span>		<span class="token expression"><span class="token number">87</span>	</span><span class="token comment">/* Too many users */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ENOTSOCK</span>	<span class="token expression"><span class="token number">88</span>	</span><span class="token comment">/* Socket operation on non-socket */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EDESTADDRREQ</span>	<span class="token expression"><span class="token number">89</span>	</span><span class="token comment">/* Destination address required */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EMSGSIZE</span>	<span class="token expression"><span class="token number">90</span>	</span><span class="token comment">/* Message too long */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EPROTOTYPE</span>	<span class="token expression"><span class="token number">91</span>	</span><span class="token comment">/* Protocol wrong type for socket */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ENOPROTOOPT</span>	<span class="token expression"><span class="token number">92</span>	</span><span class="token comment">/* Protocol not available */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EPROTONOSUPPORT</span>	<span class="token expression"><span class="token number">93</span>	</span><span class="token comment">/* Protocol not supported */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ESOCKTNOSUPPORT</span>	<span class="token expression"><span class="token number">94</span>	</span><span class="token comment">/* Socket type not supported */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EOPNOTSUPP</span>	<span class="token expression"><span class="token number">95</span>	</span><span class="token comment">/* Operation not supported on transport endpoint */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EPFNOSUPPORT</span>	<span class="token expression"><span class="token number">96</span>	</span><span class="token comment">/* Protocol family not supported */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EAFNOSUPPORT</span>	<span class="token expression"><span class="token number">97</span>	</span><span class="token comment">/* Address family not supported by protocol */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EADDRINUSE</span>	<span class="token expression"><span class="token number">98</span>	</span><span class="token comment">/* Address already in use */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EADDRNOTAVAIL</span>	<span class="token expression"><span class="token number">99</span>	</span><span class="token comment">/* Cannot assign requested address */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ENETDOWN</span>	<span class="token expression"><span class="token number">100</span>	</span><span class="token comment">/* Network is down */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ENETUNREACH</span>	<span class="token expression"><span class="token number">101</span>	</span><span class="token comment">/* Network is unreachable */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ENETRESET</span>	<span class="token expression"><span class="token number">102</span>	</span><span class="token comment">/* Network dropped connection because of reset */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ECONNABORTED</span>	<span class="token expression"><span class="token number">103</span>	</span><span class="token comment">/* Software caused connection abort */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ECONNRESET</span>	<span class="token expression"><span class="token number">104</span>	</span><span class="token comment">/* Connection reset by peer */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ENOBUFS</span>		<span class="token expression"><span class="token number">105</span>	</span><span class="token comment">/* No buffer space available */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EISCONN</span>		<span class="token expression"><span class="token number">106</span>	</span><span class="token comment">/* Transport endpoint is already connected */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ENOTCONN</span>	<span class="token expression"><span class="token number">107</span>	</span><span class="token comment">/* Transport endpoint is not connected */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ESHUTDOWN</span>	<span class="token expression"><span class="token number">108</span>	</span><span class="token comment">/* Cannot send after transport endpoint shutdown */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ETOOMANYREFS</span>	<span class="token expression"><span class="token number">109</span>	</span><span class="token comment">/* Too many references: cannot splice */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ETIMEDOUT</span>	<span class="token expression"><span class="token number">110</span>	</span><span class="token comment">/* Connection timed out */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ECONNREFUSED</span>	<span class="token expression"><span class="token number">111</span>	</span><span class="token comment">/* Connection refused */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EHOSTDOWN</span>	<span class="token expression"><span class="token number">112</span>	</span><span class="token comment">/* Host is down */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EHOSTUNREACH</span>	<span class="token expression"><span class="token number">113</span>	</span><span class="token comment">/* No route to host */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EALREADY</span>	<span class="token expression"><span class="token number">114</span>	</span><span class="token comment">/* Operation already in progress */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EINPROGRESS</span>	<span class="token expression"><span class="token number">115</span>	</span><span class="token comment">/* Operation now in progress */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ESTALE</span>		<span class="token expression"><span class="token number">116</span>	</span><span class="token comment">/* Stale file handle */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EUCLEAN</span>		<span class="token expression"><span class="token number">117</span>	</span><span class="token comment">/* Structure needs cleaning */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ENOTNAM</span>		<span class="token expression"><span class="token number">118</span>	</span><span class="token comment">/* Not a XENIX named type file */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ENAVAIL</span>		<span class="token expression"><span class="token number">119</span>	</span><span class="token comment">/* No XENIX semaphores available */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EISNAM</span>		<span class="token expression"><span class="token number">120</span>	</span><span class="token comment">/* Is a named type file */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EREMOTEIO</span>	<span class="token expression"><span class="token number">121</span>	</span><span class="token comment">/* Remote I/O error */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EDQUOT</span>		<span class="token expression"><span class="token number">122</span>	</span><span class="token comment">/* Quota exceeded */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ENOMEDIUM</span>	<span class="token expression"><span class="token number">123</span>	</span><span class="token comment">/* No medium found */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EMEDIUMTYPE</span>	<span class="token expression"><span class="token number">124</span>	</span><span class="token comment">/* Wrong medium type */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ECANCELED</span>	<span class="token expression"><span class="token number">125</span>	</span><span class="token comment">/* Operation Canceled */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ENOKEY</span>		<span class="token expression"><span class="token number">126</span>	</span><span class="token comment">/* Required key not available */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EKEYEXPIRED</span>	<span class="token expression"><span class="token number">127</span>	</span><span class="token comment">/* Key has expired */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EKEYREVOKED</span>	<span class="token expression"><span class="token number">128</span>	</span><span class="token comment">/* Key has been revoked */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EKEYREJECTED</span>	<span class="token expression"><span class="token number">129</span>	</span><span class="token comment">/* Key was rejected by service */</span></span>

<span class="token comment">/* for robust mutexes */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EOWNERDEAD</span>	<span class="token expression"><span class="token number">130</span>	</span><span class="token comment">/* Owner died */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ENOTRECOVERABLE</span>	<span class="token expression"><span class="token number">131</span>	</span><span class="token comment">/* State not recoverable */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ERFKILL</span>		<span class="token expression"><span class="token number">132</span>	</span><span class="token comment">/* Operation not possible due to RF-kill */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EHWPOISON</span>	<span class="token expression"><span class="token number">133</span>	</span><span class="token comment">/* Memory page has hardware error */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

</code></pre></div></li></ul></li> <li><p>创建线程的使用</p></li></ul></li></ul> <p><strong>代码示例</strong></p> <div class="language-c extra-class"><pre class="language-c"><code>include <span class="token string">&quot;stdio.h&quot;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;pthread.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;string.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stdlib.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;unistd.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;sys/types.h&quot;</span></span>

<span class="token keyword">void</span> <span class="token function">print_id</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>
        <span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span>
        pid <span class="token operator">=</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tid <span class="token operator">=</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s pid is %u , tid is %u\n&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span>pid<span class="token punctuation">,</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">thread_fun</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token function">print_id</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token class-name">pthread_t</span> self<span class="token punctuation">;</span>
        <span class="token keyword">int</span> err<span class="token punctuation">;</span>
        err <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>self<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>thread_fun<span class="token punctuation">,</span><span class="token string">&quot;new thread name is sutinghu&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;thread create failure\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">print_id</span><span class="token punctuation">(</span><span class="token string">&quot;main thread:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>结果</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@localhost test<span class="token punctuation">]</span><span class="token comment"># ./thread_create </span>
main thread: pid is <span class="token number">14794</span> , tid is <span class="token number">1560885056</span>
new thread name is sutinghu pid is <span class="token number">14794</span> , tid is <span class="token number">1552488192</span>
</code></pre></div><h3 id="线程的生命周期"><a href="#线程的生命周期" class="header-anchor">#</a> 线程的生命周期</h3> <p>主函数中的 <code>main</code> 方法也是一个线程，它被称为<strong>主线程</strong> 。</p> <blockquote><p><a href="https://zhuanlan.zhihu.com/p/175943809" target="_blank" rel="noopener noreferrer">Linux线程生命周期与状态 <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h4 id="生命周期"><a href="#生命周期" class="header-anchor">#</a> 生命周期</h4> <ol><li>当<code>C程序运</code>行时，首先运行<code>main</code>函数，在线程代码中，这个特殊的执行流程被称为 <strong>初始线程 或 主线程</strong>。</li> <li>主线程的特殊性在于，它在<code>main函数</code>返回的时候，会导致进程结束，进程内所有的线程都会结束。</li> <li>在主线程中使用 <code>pthread_exit()</code> 函数，这样进程会等待所有线程结束时终止</li> <li>主线程接受参数的方式是通过 <code>argc</code> 和````argv<code>普通的线程只有一个参数</code>void*```</li> <li>在绝大多数情况下，主线程在默认堆栈上运行，这个堆栈可以增长到足够的长度，而普通的线程的堆栈是受限制的，一旦溢出就会出错。</li> <li>主线程和其他子线程获取在整个CPU时钟周期中<strong>获得资源调度的程度是均等</strong>的,也就是说所有线程默认状态下是<strong>异步独立</strong>运行的。</li> <li>主线程是随着进程的创建而创建</li> <li>其它线程可以通过调用函数来创建，主要调用 pthread_create</li> <li>新线程可能在当前线程从函数 pthread_create 返回之前就已经运行了，甚至新线程可能在当前线程从pthread_create返回之前就已经运行完毕了</li></ol> <h4 id="线程状态"><a href="#线程状态" class="header-anchor">#</a> 线程状态</h4> <ul><li><p><strong>就绪</strong>：等待可用的CPU资源，其他条件一切准备好。当线程被pthread_create创建时或者阻塞状态结束后就处于准备状态。</p></li> <li><p><strong>运行</strong> ：线程已经获得CPU的使用权，并且正在运行，在多核心的机器中同时存在多个线程正在运行。如果这种情况不加以控制，会造成整个程序没响应。</p></li> <li><p><strong>阻塞</strong>：指一个线程在执行过程中暂停，以等待某个条件的触发。</p></li> <li><ul><li>例如线程可能在处理有关I/O的任务，可能I/O设备繁忙尚未响应或没有可用的I/O缓存。</li> <li>也可能当前线程等待一个可用的条件便来变量。</li> <li>错误地对一个已被锁住的互斥量加锁</li> <li>调用sigwait等待尚未发生的信号。</li></ul></li> <li><p><strong>终止</strong>：线程已经从回调函数中返回，或者调用pthread_exit返回，或者被强制终止。</p></li></ul> <img src="/imags/xc_smzq.png" alt="xc_smzq"> <h4 id="线程的回收"><a href="#线程的回收" class="header-anchor">#</a> 线程的回收</h4> <ol><li>线程默认是 非分离的</li> <li>具有分离性的线程，终止时会立刻被回收，回收将释放所有线程终止时来释放的系统资源</li> <li>线程占用的程序资源，需要自己释放</li> <li>没有被分离的线程在终止时，保留了虚拟内存及系统资源，这种线程被称为僵尸线程</li></ol> <h2 id="线程的控制"><a href="#线程的控制" class="header-anchor">#</a> 线程的控制</h2> <p>线程的控制是指通过一些特定的函数对线程进行终止、连接、取消、清除等操作。</p> <h3 id="线程终止"><a href="#线程终止" class="header-anchor">#</a> 线程终止</h3> <ul><li><p>exit 是危险的</p> <ul><li>如果进程中的任意一个线程调用了exit，_Exit， _exit，那么整个进程就会终止。</li></ul></li> <li><p>普通的单个线程有3种方式退出（不会终止进程）</p> <ul><li><p>从启动例程中返回，返回值是线程的退出码</p></li> <li><p>线程可以被同一进程中的其它线程取消</p></li> <li><p>线程调用pthread_exit(void *rval) 函数，rval是退出码</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>retval<span class="token punctuation">)</span><span class="token punctuation">;</span>
函数总数成功的
</code></pre></div><div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stdio.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;pthread.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;string.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stdlib.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;unistd.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;sys/types.h&quot;</span></span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">thread_fun</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;new thread return\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;new thread pthread_exit\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;new thread exit\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">int</span> err<span class="token punctuation">;</span>
        <span class="token class-name">pthread_t</span> self<span class="token punctuation">;</span>
        err <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>self<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>thread_fun<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create new thread failed\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul></li></ul> <h3 id="线程链接"><a href="#线程链接" class="header-anchor">#</a> 线程链接</h3> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">pthread_join</span><span class="token punctuation">(</span><span class="token class-name">pthread_t</span> tid<span class="token punctuation">,</span><span class="token keyword">void</span> <span class="token operator">*</span>rval<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">pthread_t</span> tid <span class="token comment">//指定线程的tid</span>
<span class="token keyword">void</span> <span class="token operator">*</span>rval <span class="token comment">//参数的rval是指定线程的返回码，如果线程被取消，那么rval是PTHREAD_CANCELED</span>
<span class="token comment">// 返回值：成功0 失败错误码</span>
</code></pre></div><ul><li>使一个线程等待另一个线程结束 ， 代码中如果没有pthread_join，主线程会很快结束从而使整个进程结束，从而使创建的线程没有机会开始执行就结束了。</li> <li>加入pthread_join后，主线程会一直等待直到等待的线程结束自己才结束，使创建的线程有机会执行。</li> <li>调用该函数会一直阻塞，直到指定的线程tid调用pthread_exit从启动例程返回或者被取消</li> <li>调用该函数会使指定线程处于分离状态，如果指定线程已经处于分离状态，那么调用就会失败</li></ul> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">pthread_detach</span><span class="token punctuation">(</span><span class="token class-name">pthread_t</span> thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
thread <span class="token comment">// 线程tid</span>
</code></pre></div><ul><li>该函数可以分离一个线程</li> <li>成功返回0 失败返回错误码</li></ul> <p><strong>函数test</strong></p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stdio.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;pthread.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;string.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stdlib.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;unistd.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;sys/types.h&quot;</span></span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">thread_fun1</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;i am thread one\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">thread_fun2</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;i am thread two&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_detach</span><span class="token punctuation">(</span><span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">int</span> err1<span class="token punctuation">,</span>err2<span class="token punctuation">;</span>
	<span class="token class-name">pthread_t</span> self1<span class="token punctuation">,</span>self2<span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>rval1<span class="token punctuation">,</span> <span class="token operator">*</span>rval2<span class="token punctuation">;</span>
	err1 <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>self1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>thread_fun1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	err2 <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>self2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>thread_fun2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err1 <span class="token operator">||</span> err2<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create new thread failed\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;my name is main thread successed!\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;join1 return code is %d\n &quot;</span><span class="token punctuation">,</span><span class="token function">pthread_join</span><span class="token punctuation">(</span>self1<span class="token punctuation">,</span><span class="token operator">&amp;</span>rval1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;join2 return code is %d\n &quot;</span><span class="token punctuation">,</span><span class="token function">pthread_join</span><span class="token punctuation">(</span>self2<span class="token punctuation">,</span><span class="token operator">&amp;</span>rval2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;thread1 exit code is %d\n&quot;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span>rval1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;thread2 exit code is %d\n&quot;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span>rval2<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;my name is main thread successed!\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>结果</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@localhost test<span class="token punctuation">]</span><span class="token comment"># gcc -lpthread -o join join.c </span>
<span class="token punctuation">[</span>root@localhost test<span class="token punctuation">]</span><span class="token comment"># ./join </span>
my name is main thread successed<span class="token operator">!</span>
i am thread twoi am thread one
join1 <span class="token builtin class-name">return</span> code is <span class="token number">0</span>
 join2 <span class="token builtin class-name">return</span> code is <span class="token number">22</span>
 thread1 <span class="token builtin class-name">exit</span> code is <span class="token number">1</span>
thread2 <span class="token builtin class-name">exit</span> code is <span class="token number">0</span>
my name is main thread successed<span class="token operator">!</span>
</code></pre></div><h3 id="线程取消"><a href="#线程取消" class="header-anchor">#</a> 线程取消</h3> <p>取消只是发送一个去请求，使得线程处于就绪状态，并不是使得线程终止。</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">pthread_cancel</span><span class="token punctuation">(</span><span class="token class-name">pthread_t</span> tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// tid 待取消的指定的线程</span>
<span class="token comment">// 成功返回0 </span>
</code></pre></div><div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">pthread_setcancelstate</span><span class="token punctuation">(</span><span class="token keyword">int</span> state<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>oldstate<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>设置线程对cancel信号的反应</li> <li>state 有两种方式
<ul><li>PTHREAD_CANCEL_ENABLE（缺省）</li> <li>PTHREAD_CANCEL DISABLE</li></ul></li></ul> <p>取消线程的类型，是线程对取消信号的响应方式，立即取消或者延时取消，线程创建时<strong>默认延时取消</strong>。延时取消是到取消点再取消。</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">pthread_setcanceltype</span><span class="token punctuation">(</span><span class="token keyword">int</span> type<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>oldtype<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>关于取消点</strong></p> <p>取消一个线程，它通常需要被取消线程的配合，线程在很多时候会查看自己是否有取消请求，如果有就主动退出，这些查看是否有取消的地方称为取消点。</p> <p>很多时候都有查看的动作：</p> <ul><li>pthread_join()</li> <li>pthread_testcancel()</li> <li>pthread_cond_wait()</li> <li>pthread_timedwait()</li> <li>sem_wait()</li> <li>sigwait()</li> <li>write</li> <li>read</li> <li>大多数的系统阻塞调用</li></ul> <h3 id="信号处理"><a href="#信号处理" class="header-anchor">#</a> 信号处理</h3> <blockquote><p><a href="https://blog.csdn.net/lsjseu/article/details/51823468" target="_blank" rel="noopener noreferrer">(linux多线程信号处理<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h4 id="pthread-kill"><a href="#pthread-kill" class="header-anchor">#</a> pthread_kill</h4> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">pthread_kill</span><span class="token punctuation">(</span><span class="token class-name">pthread_t</span> tid<span class="token punctuation">,</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>不会杀掉线程，而是发送一个信号量</li> <li>tid 要发送信号的线程tid</li> <li>sig 信号 0是保留信号，作用是用来判断线程是不是还活着</li> <li>返回值
<ul><li>成功 0</li> <li>线程不存在 ESRCH</li> <li>线程不合法 EINVAL</li></ul></li></ul> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> kill_rc <span class="token operator">=</span> <span class="token function">pthread_kill</span><span class="token punctuation">(</span>thread_id<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>kill_rc <span class="token operator">==</span> ESRCH<span class="token punctuation">)</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;the specified thread did not exists or already quit\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>kill_rc <span class="token operator">==</span> EINVAL<span class="token punctuation">)</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;signal is invalid\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">else</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;the specified thread is alive\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="信号处理-2"><a href="#信号处理-2" class="header-anchor">#</a> 信号处理</h4> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">sigaction</span><span class="token punctuation">(</span><span class="token keyword">int</span> signum<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sigaction</span> <span class="token operator">*</span>act<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">sigaction</span> <span class="token operator">*</span>oldact<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>给信号signum设置一个处理函数，处理函数在sigction中指定</p> <p>act.sa_mask 信号屏蔽字</p> <p>act.sa_handler 信号集处理程序</p> <p>int sigemptyset(sigset_t *set);清空信号集</p> <p>int sigfillset(sigset_t *set);将所有信号加入信号集</p> <p>int sigaddset(sigset_t *set,int signum);增加一个信号到信号集</p> <p>int sigdelset(sigset_t *set,int signum);删除一个信号到信号集</p> <h2 id="线程的同步"><a href="#线程的同步" class="header-anchor">#</a> 线程的同步</h2> <h3 id="互斥量"><a href="#互斥量" class="header-anchor">#</a> 互斥量</h3> <p>互斥量是另一种用于多线程中的同步访问方法，它允许程序锁住某个对象，使得每次只能有一个线程访问它。为了控制对关键代码的访问，必须在进入这段代码之前锁住一个互斥量，然后在完成操作之后解锁。</p> <h4 id="为什么要使用互斥量"><a href="#为什么要使用互斥量" class="header-anchor">#</a> 为什么要使用互斥量</h4> <p>使用互斥量可以确保<strong>线程同步</strong>。</p> <p><strong>寄存器处理数据+1操作一般分为三步</strong></p> <ul><li>从内存读变量值到寄存器</li> <li>寄存器的值加1</li> <li>将寄存器的值写回内存</li></ul> <img src="/imags/dxc_tbswt.png" alt="dxc_tbswt"> <p>当多个线程共享相同的内存时，需要每一个线程看到相同的视图。当一个线程修改变量时，其它线程也可以读取或者修改这个变量，就需要对这些线程进行同步操作，确保访问的变量不会混乱无效出错。</p> <h4 id="互斥锁的初始化、上锁、解锁、销毁"><a href="#互斥锁的初始化、上锁、解锁、销毁" class="header-anchor">#</a> 互斥锁的初始化、上锁、解锁、销毁</h4> <ul><li>互斥量是<code>pthread_mutex_t</code>类型的变量。</li> <li>互斥量有两种状态：<code>lock（上锁）</code>、<code>unlock（解锁）</code></li> <li>当对一个互斥量加锁后，其他任何试图访问互斥量的线程都会被堵塞，直到当前线程释放互斥锁上的锁。</li> <li>如果释放互斥量上的锁后，有多个堵塞线程，这些线程只能按一定的顺序得到互斥量的访问权限，完成对共享资源的访问后，要对互斥量进行解锁，否则其他线程将一直处于阻塞状态。</li></ul> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>

<span class="token comment">//pthread_mutex_t是锁类型，用来定义互斥锁</span>
<span class="token class-name">pthread_mutex_t</span> mutex <span class="token operator">=</span> PTHREAD_MUTEX_INITIALIZER<span class="token punctuation">;</span>

<span class="token comment">//互斥锁的初始化</span>
<span class="token comment">//restrict，C语言中的一种类型限定符，用于告诉编译器，对象已经被指针所引用，不能通过除该指针外所有其他直接或间接的方式修改该对象的内容。 第二个参数一般为NULL</span>
<span class="token keyword">int</span> <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token class-name">pthread_mutex_t</span> <span class="token operator">*</span>restrict mutex<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">pthread_mutexattr_t</span> <span class="token operator">*</span>restrict attr<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//上锁</span>
<span class="token keyword">int</span> <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token class-name">pthread_mutex_t</span> <span class="token operator">*</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//判断是否上锁</span>
<span class="token comment">//返回值：0表示已上锁，非0表示未上锁。</span>
<span class="token keyword">int</span> <span class="token function">pthread_mutex_trylock</span><span class="token punctuation">(</span><span class="token class-name">pthread_mutex_t</span> <span class="token operator">*</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//解锁 </span>
<span class="token keyword">int</span> <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token class-name">pthread_mutex_t</span> <span class="token operator">*</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//销毁互斥锁</span>
<span class="token keyword">int</span> <span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span><span class="token class-name">pthread_mutex_t</span> <span class="token operator">*</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>函数test</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;windows.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;queue&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;include/pthread.h&quot;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_WIN64</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">comment</span><span class="token punctuation">(</span>lib<span class="token punctuation">,</span></span><span class="token string">&quot;.\\lib32\\pthreadVC2.lib&quot;</span><span class="token expression"><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">comment</span><span class="token punctuation">(</span>lib<span class="token punctuation">,</span></span><span class="token string">&quot;.\\lib64\\pthreadVC2.lib&quot;</span><span class="token expression"><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> </span>

<span class="token comment">/*
4、	互斥量用pthread_mutex_t类型的数据表示，在使用之前需要对互斥量初始化
1）、如果是动态分配的互斥量，在申请内存(malloc)之后, 可以调用pthread_mutex_init（）函数初始化
2）、如果是静态分配的互斥量，不需要调用 pthread_mutex_init() 函数。还可以把它置为常量PTHREAD_MUTEX_INITIALIZER
3）、动态分配的互斥量在释放内存之前需要调用pthread_mutex_destroy（）
*/</span>

<span class="token class-name">pthread_mutex_t</span> mutex <span class="token operator">=</span> PTHREAD_MUTEX_INITIALIZER<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">queue</span> <span class="token punctuation">{</span>
	<span class="token keyword">int</span> len<span class="token punctuation">;</span>
	<span class="token keyword">int</span> write_pos<span class="token punctuation">;</span>
	<span class="token keyword">int</span> read_pos<span class="token punctuation">;</span>
	<span class="token keyword">int</span> data<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">queue</span> <span class="token operator">*</span><span class="token function">queue_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">queue</span> <span class="token operator">*</span>que<span class="token punctuation">;</span>
	<span class="token comment">//申请内存</span>
	que <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">queue</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">queue</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>que <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;malloc failed\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//初始化</span>
	que<span class="token operator">-&gt;</span>len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	que<span class="token operator">-&gt;</span>write_pos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	que<span class="token operator">-&gt;</span>read_pos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> que<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">queue_destroy</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">queue</span> <span class="token operator">*</span>que<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token comment">//销毁互斥量和que</span>
	<span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>que<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">queue_add</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">queue</span> <span class="token operator">*</span>que <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">queue</span> <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>
	<span class="token keyword">int</span> buf <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span>buf <span class="token operator">&lt;</span> <span class="token number">50</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
		que<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span>que<span class="token operator">-&gt;</span>write_pos<span class="token punctuation">]</span> <span class="token operator">=</span> buf<span class="token punctuation">;</span>
		que<span class="token operator">-&gt;</span>write_pos<span class="token operator">++</span><span class="token punctuation">;</span>
		que<span class="token operator">-&gt;</span>len<span class="token operator">++</span><span class="token punctuation">;</span>
		buf<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;write data %d   to   queue\n&quot;</span><span class="token punctuation">,</span> que<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span>que<span class="token operator">-&gt;</span>write_pos <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">queue_del</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">queue</span> <span class="token operator">*</span>que <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">queue</span> <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>
	<span class="token keyword">int</span> buf <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
		buf <span class="token operator">=</span> que<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span>que<span class="token operator">-&gt;</span>read_pos<span class="token punctuation">]</span><span class="token punctuation">;</span>
		que<span class="token operator">-&gt;</span>read_pos<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>que<span class="token operator">-&gt;</span>len<span class="token operator">--</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;queue is empty\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		buf<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;read  data %d   from queue\n&quot;</span><span class="token punctuation">,</span> que<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span>que<span class="token operator">-&gt;</span>read_pos <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token class-name">pthread_t</span> tid1<span class="token punctuation">,</span> tid2<span class="token punctuation">;</span>
	<span class="token keyword">int</span> err<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">queue</span> <span class="token operator">*</span>que<span class="token punctuation">;</span>

	<span class="token comment">//队列和锁都要初始化</span>
	que <span class="token operator">=</span> <span class="token function">queue_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//如果是静态分配的互斥量，不需要调用 pthread_mutex_init() 函数。</span>
	<span class="token comment">//还可以把它置为常量PTHREAD_MUTEX_INITIALIZER</span>
	<span class="token comment">/*err = pthread_mutex_init(&amp;mutex, NULL);
	if (err)
	{
		printf(&quot;mutex init failed\n&quot;);
		free(que);
		return 0;
	}
*/</span>
	err <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid1<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> queue_add<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>que<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create add thread failed\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">queue_destroy</span><span class="token punctuation">(</span>que<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	err <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid2<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> queue_del<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>que<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create del thread failed\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">queue_destroy</span><span class="token punctuation">(</span>que<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//等待增加和删除操作完成</span>
	<span class="token function">pthread_join</span><span class="token punctuation">(</span>tid1<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_join</span><span class="token punctuation">(</span>tid2<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//销毁</span>
	<span class="token function">queue_destroy</span><span class="token punctuation">(</span>que<span class="token punctuation">)</span><span class="token punctuation">;</span>


	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="死锁的情况"><a href="#死锁的情况" class="header-anchor">#</a> 死锁的情况</h4> <ul><li>同一个线程已拥有A锁的情况下，再次请求获取A锁，导致线程阻塞
解决方法：使用完资源后立刻解锁</li> <li>线程一拥有A锁，再次请求获取B锁，同时线程二拥有B锁，请求获取A锁，导致线程阻塞
解决方法：当拥有锁的情况下，请求获取另外一把锁失败时，释放已拥有的锁</li></ul> <h3 id="读写锁"><a href="#读写锁" class="header-anchor">#</a> 读写锁</h3> <h4 id="读写锁与互斥锁的区别"><a href="#读写锁与互斥锁的区别" class="header-anchor">#</a> 读写锁与互斥锁的区别</h4> <p>互斥量可以使得多线程并行，但是带来了新的问题， 即同一时刻只有一个线程能运行，其他竞争不到互斥量的线程会被阻塞，这就阻碍了程序的并行性。</p> <p>读写锁与互斥量类似，不过读写锁有更高的并行性。对于一个变量的读操作，完全可以让多个线程同时进行操作，多个读操作同时进行不会改变数据。</p> <h4 id="读写锁的状态"><a href="#读写锁的状态" class="header-anchor">#</a> 读写锁的状态</h4> <p>读写锁非常适合对数据结构读次数大于写次敌的程序，当它以读模式锁住时，是以共享的方式锁住的;当它以写模式谈住时,是以独占的模式谈住的。</p> <ul><li>读模式下加锁
<ul><li>多个线程可以同时占有读模式的读写锁</li> <li>所有试图以读模式对其加锁的线程都会获得访问权，但是如果线程希望以写模式对其加锁，它必须阻塞直到所有的线程释放锁</li></ul></li> <li>写模式下加锁
<ul><li>一次只有一个线程可以占有写模式下的读写锁</li> <li>读写锁在写加锁状态时，在它被解锁之前，所有试图对这个锁加锁的线程都会阻塞</li> <li>线程试图以写模式对其加锁，那么读写锁会阻塞随后的读模式锁请求</li></ul></li> <li>不加锁</li></ul> <h4 id="读写锁的初始化和销毁"><a href="#读写锁的初始化和销毁" class="header-anchor">#</a> 读写锁的初始化和销毁</h4> <p><strong>读写锁在使用之前必须初始化</strong></p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">pthread_rwlock_init</span><span class="token punctuation">(</span><span class="token class-name">pthread_rwlock_t</span> <span class="token operator">*</span>restrict rwlock<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">pthread_rwlockattr_t</span> <span class="token operator">*</span>restrict attz<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>成功返回0﹐共败返回错误码</p> <p><strong>使用完需要销毁</strong></p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">pthread_rwlock_destroy</span><span class="token punctuation">(</span><span class="token class-name">pthread_rwlock_t</span> <span class="token operator">*</span>rwlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>成功返回0﹐共败返回错误码</p> <h4 id="读模式加锁"><a href="#读模式加锁" class="header-anchor">#</a> 读模式加锁</h4> <div class="language-c extra-class"><pre class="language-c"><code>NAME
       pthread_rwlock_rdlock<span class="token punctuation">,</span> pthread_rwlock_tryrdlock — lock a read<span class="token operator">-</span>write lock object <span class="token keyword">for</span> reading

SYNOPSIS
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>

       <span class="token keyword">int</span> <span class="token function">pthread_rwlock_rdlock</span><span class="token punctuation">(</span><span class="token class-name">pthread_rwlock_t</span> <span class="token operator">*</span>rwlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">int</span> <span class="token function">pthread_rwlock_tryrdlock</span><span class="token punctuation">(</span><span class="token class-name">pthread_rwlock_t</span> <span class="token operator">*</span>rwlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="写模式加锁"><a href="#写模式加锁" class="header-anchor">#</a> 写模式加锁</h4> <div class="language-c extra-class"><pre class="language-c"><code>NAME
       pthread_rwlock_trywrlock<span class="token punctuation">,</span> pthread_rwlock_wrlock — lock a read<span class="token operator">-</span>write lock object <span class="token keyword">for</span> writing

SYNOPSIS
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>

       <span class="token keyword">int</span> <span class="token function">pthread_rwlock_trywrlock</span><span class="token punctuation">(</span><span class="token class-name">pthread_rwlock_t</span> <span class="token operator">*</span>rwlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">int</span> <span class="token function">pthread_rwlock_wrlock</span><span class="token punctuation">(</span><span class="token class-name">pthread_rwlock_t</span> <span class="token operator">*</span>rwlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="读写锁的解锁"><a href="#读写锁的解锁" class="header-anchor">#</a> 读写锁的解锁</h4> <div class="language-c extra-class"><pre class="language-c"><code>NAME
       pthread_rwlock_unlock — unlock a read<span class="token operator">-</span>write lock object

SYNOPSIS
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>

       <span class="token keyword">int</span> <span class="token function">pthread_rwlock_unlock</span><span class="token punctuation">(</span><span class="token class-name">pthread_rwlock_t</span> <span class="token operator">*</span>rwlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="函数实例"><a href="#函数实例" class="header-anchor">#</a> 函数实例</h4> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

using namespace std<span class="token punctuation">;</span>

<span class="token class-name">pthread_rwlock_t</span> rwlock<span class="token punctuation">;</span>

<span class="token keyword">int</span> shared_num <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>

<span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">thread_fun1</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">pthread_rwlock_wrlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;thread 1: &quot;</span> <span class="token operator">&lt;&lt;</span> shared_num <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
  <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">pthread_rwlock_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlock<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">thread_fun2</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">pthread_rwlock_rdlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;thread 2: &quot;</span> <span class="token operator">&lt;&lt;</span> shared_num <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
  <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">pthread_rwlock_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token class-name">pthread_t</span> tid1<span class="token punctuation">,</span> tid2<span class="token punctuation">;</span>

  <span class="token function">pthread_rwlock_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlock<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid1<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> thread_fun1<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid2<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> thread_fun2<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid1<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid2<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">pthread_rwlock_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlock<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="条件变量"><a href="#条件变量" class="header-anchor">#</a> 条件变量</h3> <h4 id="为什么需要条件变量"><a href="#为什么需要条件变量" class="header-anchor">#</a> 为什么需要条件变量</h4> <blockquote><ol><li><p>有一个IO请求队列，入队线程不断的往队列里面push_back请求，出队线程不断的从队列里面pop_front请求。</p></li> <li><p>入队线程在push_back的时候要独占队列，出队线程在pop_front的时候也要独占队列。</p></li> <li><p>如果在某一时刻，入队线程抢到了互斥量，但是发现队列是满的，自己不断的轮询查询队列是否非满状态这样很消耗CPU资源，也导致无意义的占用锁资源。</p></li> <li><p>出队线程由于拿不到互斥量，一直阻塞。这样会导致程序僵死或者时间消耗变大。</p></li> <li><p>换句话说就是当线程拿到锁之后，如果发现不满足自己的执行条件就应该立即释放锁，并阻塞在当前位置，等待满足自己的执行条件时，通过某种途径来唤醒它继续运行。</p></li></ol> <blockquote><p>如，入队线程查询到队列是满的时候，就应该释放锁，出队线程开始工作消耗队列。</p></blockquote> <p>这时我们引入条件变量来解决这种场景。</p></blockquote> <h4 id="条件队列的初始化、销毁"><a href="#条件队列的初始化、销毁" class="header-anchor">#</a> 条件队列的初始化、销毁</h4> <p><strong>条件变量的申明：pthread_cond_t cond;</strong></p> <div class="language-c extra-class"><pre class="language-c"><code>NAME
       pthread_cond_init — initialize condition variables

SYNOPSIS
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>

       <span class="token keyword">int</span> <span class="token function">pthread_cond_init</span><span class="token punctuation">(</span><span class="token class-name">pthread_cond_t</span> <span class="token operator">*</span>restrict cond<span class="token punctuation">,</span>
           <span class="token keyword">const</span> <span class="token class-name">pthread_condattr_t</span> <span class="token operator">*</span>restrict attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>第一个参数是创建的条件变量，第二个参数是属性，默认为NULL</p> <div class="language-c extra-class"><pre class="language-c"><code>NAME
       pthread_cond_destroy — destroy condition variables

SYNOPSIS
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>

       <span class="token keyword">int</span> <span class="token function">pthread_cond_destroy</span><span class="token punctuation">(</span><span class="token class-name">pthread_cond_t</span> <span class="token operator">*</span>cond<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="条件队列的使用"><a href="#条件队列的使用" class="header-anchor">#</a> 条件队列的使用</h4> <div class="language-c extra-class"><pre class="language-c"><code>NAME
       pthread_cond_wait — wait on a condition

SYNOPSIS
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>

       <span class="token keyword">int</span> <span class="token function">pthread_cond_wait</span><span class="token punctuation">(</span><span class="token class-name">pthread_cond_t</span> <span class="token operator">*</span>restrict cond<span class="token punctuation">,</span>
           <span class="token class-name">pthread_mutex_t</span> <span class="token operator">*</span>restrict mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li><p>需要等待条件为真，即等待传入的第一个参数cond，执行pthread_cond_wait函数的线程会阻塞，直到cond条件为真，线程恢复运行。</p></li> <li><p>第二个参数互斥量mutex，就是线程在还没发现是否满足自己条件时加的锁，在pthread_cond_wait函数里面进行释放。当条件满足时，继续对互斥量加锁，线程就可以在满足自己条件的情况下继续往下执行。</p></li> <li><p>这一系列动作都由pthread_cond_wait在完成。</p></li></ul> <div class="language-c extra-class"><pre class="language-c"><code>NAME
       pthread_cond_timedwait — wait on a condition

SYNOPSIS
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>

       <span class="token keyword">int</span> <span class="token function">pthread_cond_timedwait</span><span class="token punctuation">(</span><span class="token class-name">pthread_cond_t</span> <span class="token operator">*</span>restrict cond<span class="token punctuation">,</span>
           <span class="token class-name">pthread_mutex_t</span> <span class="token operator">*</span>restrict mutex<span class="token punctuation">,</span>
           <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">timespec</span> <span class="token operator">*</span>restrict abstime<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>在等待条件变量cond为真的过程中增加等待时间，超过等待时间就不等了，直接返回。</li></ul> <p><strong>当条件满足时，需要唤醒等待条件变量的线程：</strong></p> <div class="language-cpp extra-class"><pre class="language-cpp"><code>NAME
       pthread_cond_broadcast<span class="token punctuation">,</span> pthread_cond_signal — broadcast <span class="token operator">or</span> signal a condition

SYNOPSIS
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>

       <span class="token keyword">int</span> <span class="token function">pthread_cond_broadcast</span><span class="token punctuation">(</span>pthread_cond_t <span class="token operator">*</span>cond<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">int</span> <span class="token function">pthread_cond_signal</span><span class="token punctuation">(</span>pthread_cond_t <span class="token operator">*</span>cond<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>唤醒等待条件变量的线程有两个函数：</p> <ul><li>pthread_cond_broadcast唤醒等待条件变量的所有线程。</li> <li>pthread_cond_signal至少唤醒等待条件变量的某一个线程，至于唤醒哪一个线程由系统的调度机制决定</li></ul> <h4 id="函数实例-2"><a href="#函数实例-2" class="header-anchor">#</a> 函数实例</h4> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;list&gt;</span></span>

using namespace std<span class="token punctuation">;</span>

<span class="token class-name">pthread_mutex_t</span> lock<span class="token punctuation">;</span> <span class="token comment">//入队,出队之前要加独占锁</span>
<span class="token class-name">pthread_cond_t</span> cond<span class="token punctuation">;</span> <span class="token comment">//条件变量</span>

list<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> _queue<span class="token punctuation">;</span> <span class="token comment">//请求队列</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">queue_max_size</span> <span class="token expression"><span class="token number">5</span> </span><span class="token comment">//队列最大存放请求个数</span></span>

<span class="token keyword">void</span> <span class="token function">_enqueue</span><span class="token punctuation">(</span><span class="token keyword">int</span> op<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>_queue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;current queue is full, please wait&quot;</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token function">pthread_cond_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cond<span class="token punctuation">,</span> <span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//队列满了就阻塞这里,并释放互斥量,等待条件变量唤醒</span>
  <span class="token punctuation">}</span>
  _queue<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">_dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> op<span class="token punctuation">;</span>
  <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>_queue<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;current queue is empty&quot;</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
    op <span class="token operator">=</span> _queue<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _queue<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_cond_signal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cond<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//通知条件变量满足条件了,唤醒因为这个条件变量阻塞的线程</span>
  <span class="token punctuation">}</span>
  <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> op<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//入队线程工作函数</span>
<span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">enqueue_op</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//每次入队的内容是一个整数</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//控制每秒入队一个请求</span>
    <span class="token function">_enqueue</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;op enqueue success: &quot;</span> <span class="token operator">&lt;&lt;</span> n <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    n<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//出队线程工作函数</span>
<span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">dequeue_op</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> op<span class="token punctuation">;</span> <span class="token comment">//每次出队的请求</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//控制每秒出队一个请求</span>
    op <span class="token operator">=</span> <span class="token function">_dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;op dequeue success &quot;</span> <span class="token operator">&lt;&lt;</span> op <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> args<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token comment">// 初始化互斥量和条件变量 </span>
  <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">pthread_cond_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cond<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 定义两个线程变量 </span>
  <span class="token class-name">pthread_t</span> th_enqueue<span class="token punctuation">,</span> th_dequeue<span class="token punctuation">;</span>
	<span class="token comment">//入队线程</span>
  <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>th_enqueue<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> enqueue_op<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">// 出队线程</span>
  <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>th_dequeue<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> dequeue_op<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//等待子线程值执行完成</span>
  <span class="token function">pthread_join</span><span class="token punctuation">(</span>th_enqueue<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">pthread_join</span><span class="token punctuation">(</span>th_dequeue<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//销毁资源</span>
  <span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">pthread_cond_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cond<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/collection/jcjtx.html" class="prev">
        进程间通信
      </a></span> <span class="next"><a href="/collection/netcode.html">
        网络编程
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.e2ddde8e.js" defer></script><script src="/assets/js/2.e74445cb.js" defer></script><script src="/assets/js/18.c5024350.js" defer></script>
  </body>
</html>
