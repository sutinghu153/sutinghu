<h1 align="center">Kafka</h1>

本文是关于Kafka实践及原理的总结。

## 关于Kafka

### 定义

分布式流式处理平台，具有高吞吐、可持久化、可水平扩展、支持流数据处理等多种特性。

- **分布式：**多服务器
- **高吞吐：**单位时间内，能传输的数据量
- **低延迟：**对一个请求，提供响应所需要的时间

### 功能

#### 消息系统

具备系统解耦、冗余存储、流量削峰、缓冲、异步通信、高拓展、可恢复性等功能

#### 存储系统

可以把消息持久化到磁盘，保证了数据丢失的风险，得益于Kafka的消息持久化功能和多副本机制

#### 流式处理平台

Kafka不仅为每个流行的流式处理框架提供了可靠的数据来源，还提供了一个完整的处理类库。类别Java中的Stream()。

## 基本框架

### 框架的组成

Kafka的基本组成包括```Producer```、```Broker```、```Consumer``` 以及一个```ZooKeeper``` 集群。

- Zookeeper : 集群管理器、负责将Kafka集群元数据的管理、控制器的选举等操作
- Producer : 消息的生产者、将消息发送到Broker
- Broker : 消息的协调者，负责将消息存储到磁盘并提供Consumer消费，也是服务的代理节点，对于Kafka而言，Broker可以简单看作一个独立的Kafka服务节点或Kafka服务实例
- Consumer : 消息的消费者，接收消息的一方

### 信息的管理

Kafka中信息即消息的管理是通过主题（Topic）和分区（Partition）进行的。

- 消息以主题为单位进行分类
- 主题可以细分为若干个分区
- 一个分区仅属于一个主题
- 同一主题下不同的分区包含的消息是不同的
- 消息在被追加到分区日志文件的时候会被追加一个偏远量，这是消息在分区中的唯一标记
- Kafka保证的是分区有序而不是主题有序
- 一个主题的不同分区可以被分布在多个broker上，即一个主题可以横跨多个broker

![image-20211223105248173](C:\Users\MSI\AppData\Roaming\Typora\typora-user-images\image-20211223105248173.png)

#### 通过分区实现水平拓展扩容

如果一个主题只对应一个文件，则该文件所在机器的I/O系统将成为这个主题的瓶颈，设计多个分区，实现消息的跨服务、跨机器的存储则解决了这个问题。

在创建主题的时候，可以通过指定的参数来设置分区的个数，即通过增加分区的方式实现水平的拓展。

#### 用多副本机制提升容灾能力

Kafka 为分区引入了多副本机制。通过增加副本的数量可以提升容灾的能力。

- 同一个分区的不同副本保存相同的信息
- 副本之间是一主多从的关系
  - leader主本负责处理读写请求
  - follower副本负责与leader主本消息同步
  - 副本在不同的broker中，当leader副本出现故障时，follower副本中将会重新选举新的leader副本对外提供服务

Kafka通过多副本机制实现了故障的自动转移，当Kafka集群中的某个broker失效时仍然能够保证服务可用

![image-20211223110415128](C:\Users\MSI\AppData\Roaming\Typora\typora-user-images\image-20211223110415128.png)

